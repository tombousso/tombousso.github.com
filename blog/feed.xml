<?xml version="1.0"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>JBake</title>
    <link>https://tombousso.github.io/blog</link>
    <atom:link href="https://tombousso.github.io/blog/feed.xml" rel="self" type="application/rss+xml" />
    <description>JBake Bootstrap Template</description>
    <language>en-gb</language>
    <pubDate>Tue, 13 Jun 2017 01:48:36 -0700</pubDate>
    <lastBuildDate>Tue, 13 Jun 2017 01:48:36 -0700</lastBuildDate>

    <item>
      <title>Unexpected JVM Behavior</title>
      <link>https://tombousso.github.io/blog/unexpected-jvm-behavior.html</link>
      <pubDate>Sun, 11 Jun 2017 00:00:00 -0700</pubDate>
      <guid isPermaLink="false">unexpected-jvm-behavior.html</guid>
      	<description>
	&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;Here&amp;#8217;s a disassembled classfile (&lt;code&gt;Test.class&lt;/code&gt;):&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code&gt;Classfile format major version: 50, minor version: 0.
Access flags: public super
Field name: x static Signature: int
Method name:&quot;&amp;lt;clinit&amp;gt;&quot; Signature: ()void
  0: iconst_1
  1: putstatic &amp;lt;Field Test.x int&amp;gt;
  4: return
Method name:&quot;main&quot; public static Signature: (java.lang.String[])void
  0: getstatic &amp;lt;Field java.lang.System.out java.io.PrintStream&amp;gt;
  3: getstatic &amp;lt;Field Test.x int&amp;gt;
  6: invokevirtual &amp;lt;Method java.io.PrintStream.println (int)void&amp;gt;
  9: return&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;This classfile &lt;em&gt;roughly&lt;/em&gt; corresponds to the following Java code:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;listingblock&quot;&gt;
&lt;div class=&quot;content&quot;&gt;
&lt;pre class=&quot;prettyprint highlight&quot;&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;public class Test {
	static int x;
	static {
		x = 1;
	}
	public static void main(String[] args) {
		System.out.println(x);
	}
}&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;So what happens when we run this classfile? The main method prints &lt;code&gt;1&lt;/code&gt;, as we would expect.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;However&amp;#8230;&amp;#8203; if we change the classfile format major version from 50 (Java 1.6) to 51 (Java 1.7)&amp;#8230;&amp;#8203; then the main method prints &lt;code&gt;0&lt;/code&gt;! The JVM doesn&amp;#8217;t run the &lt;code&gt;&amp;lt;clinit&amp;gt;&lt;/code&gt; method.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;paragraph&quot;&gt;
&lt;p&gt;If you look back at the disassembled classfile, you might notice that the &lt;code&gt;&amp;lt;clinit&amp;gt;&lt;/code&gt; method is not static (that is, it doesn&amp;#8217;t have the &lt;code&gt;ACC_STATIC&lt;/code&gt; flag set). Surprisingly, JVM version 1.6 didn&amp;#8217;t care whether or not &lt;code&gt;&amp;lt;clinit&amp;gt;&lt;/code&gt; methods are defined as static. When this issue was reported in 2009, the fix was to disallow non-static &lt;code&gt;&amp;lt;clinit&amp;gt;&lt;/code&gt; methods when the classfile major version is greater than 50 (for backwards compatibility). I ran into this quirk while working on &lt;a href=&quot;https://github.com/tombousso/sJava&quot;&gt;sJava&lt;/a&gt;, but as usual reading the JVM Specification would have saved me some trouble:&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;quoteblock&quot;&gt;
&lt;blockquote&gt;
In a class file whose version number is 51.0 or above, the method [&amp;lt;clinit&amp;gt;] must additionally have its ACC_STATIC flag (ยง4.6) set in order to be the class or interface initialization method.
&lt;/blockquote&gt;
&lt;div class=&quot;attribution&quot;&gt;
&amp;#8212; &lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9&quot; class=&quot;bare&quot;&gt;https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9&lt;/a&gt;
&lt;/div&gt;
&lt;/div&gt;
	</description>
    </item>

  </channel> 
</rss>
